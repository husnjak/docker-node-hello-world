AWSTemplateFormatVersion: '2010-09-09'
Description: Create ECS Service with Fargate

Resources:
# ---- Docker Container settings ----
  IGDBcomCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: igdbcom-cluster
  
  IGDBcomTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      RequiresCompatibilities:
          - "FARGATE"
      Cpu: "1024"
      Memory: "2048"
      NetworkMode: "awsvpc"
      ExecutionRoleArn: !GetAtt IGDBcomExecutionRole.Arn
      TaskRoleArn: !GetAtt IGDBcomExecutionRole.Arn
      Family: "igdbcom"
      LoadBalancers:
        - 
          ContainerName: "igdbcom-container"
          ContainerPort: 4000
          LoadBalancerName: "igdbcom-loadbalancer"
          TargetGroupArn: !Ref IGDBELBTargetGroup
        
      ContainerDefinitions:
        - 
          Name: "igdbcom-container"
          Image: 121715975140.dkr.ecr.us-east-1.amazonaws.com/igdbcom-image
          PortMappings: 
            - 
              ContainerPort: 4000
              HostPort: 4000
              Protocol: tcp

  IGDBcomService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref IGDBcomCluster
      LaunchType: FARGATE
      DesiredCount: 1
      NetworkConfiguration: 
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref IGDBcomSecurityGroup
          Subnets: 
            - !Ref Subnet1
      ServiceName: "igdbcom-service"
      TaskDefinition: !Ref IGDBcomTaskDefinition

# ---- AWS Internet Access settings ----

  IGDBELBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Join ['-', [!Ref 'AWS::StackName', 'igdb']]
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref 'IGDBcomVPC'
      TargetType: 'ip'

  IGDBcomVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      Tags:
        - 
          Key: "Name"
          Value: "IGDBcom"
  
  Subnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: us-east-1a
      VpcId: !Ref IGDBcomVPC
      CidrBlock: 10.0.6.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - 
          Key: "Name"
          Value: "IGDBcom"
  
  Subnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: us-east-1f
      VpcId: !Ref IGDBcomVPC
      CidrBlock: 10.0.24.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - 
          Key: "Name"
          Value: "IGDBcom"
  
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
          - 
            Key: "Name"
            Value: "IGDBcom"
  
  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref IGDBcomVPC
  
  IGDBcomSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for IGDBcom"
      GroupName: "igdbcom-security"
      SecurityGroupIngress: 
        - 
          IpProtocol: tcp
          FromPort: 4000
          ToPort: 4000
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress: 
        - 
          IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
      VpcId: !Ref IGDBcomVPC
      Tags:
        - 
          Key: "Name"
          Value: "IGDBcom"

  IGDBcomRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref IGDBcomVPC
      Tags:
        - 
          Key: "Name"
          Value: "IGDBcom"

  IGDBcomRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref IGDBcomRouteTable

  IGDBRouteSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref IGDBcomRouteTable
      SubnetId: !Ref Subnet1

  IGDBRouteSubnetAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref IGDBcomRouteTable
      SubnetId: !Ref Subnet2

# ---- ECS execution role ----

  IGDBcomExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "igdbcom-execution-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - 
          PolicyName: "igdbcom-execution-policy"
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
              - ecr:GetAuthorizationToken
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
              - logs:CreateLogStream
              - logs:PutLogEvents
              Resource: "*"

